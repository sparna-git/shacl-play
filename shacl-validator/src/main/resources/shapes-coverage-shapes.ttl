@prefix rdf:  <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix sh:   <http://www.w3.org/ns/shacl#> .
@prefix xsd:  <http://www.w3.org/2001/XMLSchema#> .
@prefix shpshapes: <https://shacl-play.sparna.fr/shapes#> .
@prefix shp:  <https://shacl-play.sparna.fr/ontology#> .

shpshapes:NodeShapeWithMinCount a sh:NodeShape ;
	# applies to every shape that has a target definition and an explicit sh:minCount
	sh:target [
		sh:select """
			PREFIX sh: <http://www.w3.org/ns/shacl#>
			PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
			PREFIX shp: <https://shacl-play.sparna.fr/ontology#>
			SELECT $this WHERE {
				{
					SELECT $this ?minCount
					WHERE {
						{
							{ $this sh:targetNode|sh:targetClass|sh:targetSubjectsOf|sh:targetObjectsOf|sh:target ?x }
							UNION
							{ $this a sh:NodeShape ; a <http://www.w3.org/2000/01/rdf-schema#Class> }
							UNION
							{ $this a sh:NodeShape ; a <http://www.w3.org/2002/07/owl#Class> }
						}
						$this sh:minCount ?minCount .
					}
				}
			}
		"""
	] ;
	sh:sparql shpshapes:hasFocusNodeMinCount ;
.

shpshapes:hasFocusNodeMinCount
	a sh:SPARQLConstraint ;
	sh:severity sh:Warning ;
	sh:message "Shape did not target enough focus nodes"@en ;
	sh:select """
		PREFIX sh: <http://www.w3.org/ns/shacl#>
		PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
		PREFIX shp: <https://shacl-play.sparna.fr/ontology#>
		SELECT $this ?minCount (COUNT(?focusNode) AS ?count) WHERE {
			{
				SELECT $this ?minCount
				WHERE {
					{
						{ $this sh:targetNode|sh:targetClass|sh:targetSubjectsOf|sh:targetObjectsOf|sh:target ?x }
						UNION
						{ $this a sh:NodeShape ; a <http://www.w3.org/2000/01/rdf-schema#Class> }
						UNION
						{ $this a sh:NodeShape ; a <http://www.w3.org/2002/07/owl#Class> }
					}
					$this sh:minCount ?minCount
				}
			}

			OPTIONAL { $this shp:hasFocusNode ?focusNode . }
		}
		GROUP BY $this ?minCount
		HAVING (COUNT(?focusNode) < ?minCount)
	"""
.


shpshapes:NodeShapeWithMaxCount a sh:NodeShape ;
	# applies to every shape that has a target definition and a sh:maxCount
	sh:target [
		sh:select """
			PREFIX sh: <http://www.w3.org/ns/shacl#>
			PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
			PREFIX shp: <https://shacl-play.sparna.fr/ontology#>
			SELECT $this WHERE {
				{
					SELECT $this ?maxCount
					WHERE {
						{
							{ $this sh:targetNode|sh:targetClass|sh:targetSubjectsOf|sh:targetObjectsOf|sh:target ?x }
							UNION
							{ $this a sh:NodeShape ; a <http://www.w3.org/2000/01/rdf-schema#Class> }
							UNION
							{ $this a sh:NodeShape ; a <http://www.w3.org/2002/07/owl#Class> }
						}
						$this sh:maxCount ?maxCount .
					}
				}
			}
		"""
	] ;
	sh:sparql shpshapes:hasFocusNodeMaxCount ;
.

shpshapes:hasFocusNodeMaxCount
	a sh:SPARQLConstraint ;
	sh:severity sh:Warning ;
	sh:message "Shape targeted too many focus nodes"@en ;
	sh:select """
		PREFIX sh: <http://www.w3.org/ns/shacl#>
		PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
		PREFIX shp: <https://shacl-play.sparna.fr/ontology#>
		SELECT $this ?maxCount (COUNT(?focusNode) AS ?count) WHERE {
			{
				SELECT $this ?maxCount
				WHERE {
					{
						{ $this sh:targetNode|sh:targetClass|sh:targetSubjectsOf|sh:targetObjectsOf|sh:target ?x }
						UNION
						{ $this a sh:NodeShape ; a <http://www.w3.org/2000/01/rdf-schema#Class> }
						UNION
						{ $this a sh:NodeShape ; a <http://www.w3.org/2002/07/owl#Class> }
					}
					$this sh:maxCount ?maxCount
				}
			}

			OPTIONAL { $this shp:hasFocusNode ?focusNode . }
		}
		GROUP BY $this ?maxCount
		HAVING (COUNT(?focusNode) > ?maxCount)
	"""
.